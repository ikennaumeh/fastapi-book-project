name: Python CI/CD

on:
    pull_request:
        branches:
            - main
    push:
        branches:
            - main

jobs:
    test:
        runs-on: ubuntu-latest
        if: github.event_name == 'pull_request'

        steps:
            - uses: actions/checkout@v4
            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.11"
            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt
                  pip install pytest pytest-asyncio httpx
            - name: Run tests
              run: |
                  pytest tests/ -v

    deploy:
        runs-on: ubuntu-latest
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'

        steps:
        - name: Checkout Repository
          uses: actions/checkout@v3
  
        - name: Deploy to Azure VM
          uses: appleboy/ssh-action@v0.1.6
          with:
            host: ${{ secrets.SECRET_HOST }}
            username: ${{ secrets.SECRET_USER }}
            password: ${{ secrets.SECRET_PASSWORD }}
            script: |
              cd ~/fastapi-book-project &&
              git pull origin main &&
              source venv/bin/activate &&
              pip install -r requirements.txt &&
              sudo systemctl restart fastapi.service